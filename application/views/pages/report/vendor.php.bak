<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-users icon-gradient bg-mean-fruit">
                </i>
            </div>
            <div>Report vendor terdaftar
                <div class="page-title-subheading">Vendor yang telah terdaftar pada sistem
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div>
            <h5>Filter</h5>
            <div class="row">
                <div class="col-md-6" style="margin-bottom: 5px;">
                    <b>Wilayah Kerja</b>
                    <select class="form-control select2" name="f_branch" id="f_branch">
                        <?php
                        $data_bidang = $this->db->where('deleted_at is null')->get('m_branch_code')->result();
                        foreach ($data_bidang as $d) {
                            echo '<option value="' . $d->official_code . '">' . $d->name . '</option>';
                        }
                        ?>
                    </select>

                </div>
                <div class="col-md-6" style="margin-bottom: 5px;">
                    <b>Kabupaten/Kota</b>
                    <select class="form-control select2" name="f_area_kerja" id="f_area_kerja">
                        <option value="">Semua</option>
                        <?php
                        $data = $this->db->where('deleted_at is null')->get('m_city')->result();
                        foreach ($data as $d) {
                            echo '<option value="' . $d->id . '">' . $d->name . '</option>';
                        }
                        ?>
                    </select>
                </div>
                <div class="col-md-6" style="margin-bottom: 5px;">
                    <b>Kompetensi</b>
                    <select class="form-control select2" name="f_kompetensi" id="f_kompetensi">
                        <option value="">Semua</option>
                        <?php $data = $this->db->where('deleted_at is null')->get(App_Model::TBL_COMPANY_COMPETENCY)->result();
                        foreach ($data as $d) {
                            echo '<option value="' . $d->id . '">' . $d->name . '</option>';
                        } ?>
                    </select>

                    <b>Bidang Usaha</b>
                    <select class="form-control select2" name="f_bidang" id="f_bidang">
                        <option value="">Semua</option>
                        <?php
                        $data_bidang = $this->db->where('deleted_at is null')->get('m_company_type')->result();
                        foreach ($data_bidang as $d) {
                            echo '<option value="' . $d->id . '">' . $d->name . '</option>';
                        }
                        ?>
                        <option value="">Semua</option>
                    </select>
                </div>

                <div class="col-md-6" style="margin-bottom: 5px;">
                    <b>Sub Kompetensi</b>
                    <select class="form-control select2" name="f_sub_kompetensi" id="f_sub_kompetensi">
                        <option value="">Semua</option>
                    </select>
                </div>
            </div>
            <br>
            <button id="btn_filter" class="btn btn-lg btn-info"><i class="fa fa-filter"></i> Filter</button>
            <hr>
        </div>

        <div class="table-responsive">

            <table id="table-report" class="table table-striped table-hover">
                <thead>
                    <th>Nama Vendor</th>
                    <th>SAP Partner No</th>
                    <th>Grup</th>
                    <th>Email</th>
                    <th>No.Telp</th>
                    <th>NPWP No</th>
                    <th>Area Kerja</th>
                    <th>Kompetensi</th>
                    <th>Sub Kompetensi</th>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</div>


<script>
    $(document).ready(function() {

        $('.select2').select2();

        let dtTable = $('#table-report').DataTable({
            "aaSorting": [],
            "retrieve": true,
            "processing": true,
            'ajax': {
                "type": "GET",
                "url": site_url + 'report/get_report_vendor',
                "data": function(d) {
                    d.f_kompetensi = $('#f_kompetensi').val();
                    d.f_sub_kompetensi = $('#f_sub_kompetensi').val();
                    d.f_area_kerja = $('#f_area_kerja').val();
                    d.f_bidang = $('#f_bidang').val();
                    d.f_branch = $('#f_branch').val();
                },
                "dataSrc": ""
            },
            'columns': [{
                    render: function(data, type, full, meta) {
                        let view = `<a href="javascript:void()" id-user="${full.id_user}" data-id='${full.id_company}' class="view_detail" >${full.name + (full.prefix_name?', '+full.prefix_name:'') }</a>`;
                        return view;
                    }
                },
                {
                    render: function(data, type, full, meta) {
                        return full.id_sap;
                    }
                },
                {
                    render: function(data, type, full, meta) {
                        return full.group_desc.replace('BP ', '');
                    }
                },
                {
                    render: function(data, type, full, meta) {
                        return full.email;
                    }
                },
                {
                    render: function(data, type, full, meta) {
                        return full.phone;
                    }
                }, {
                    render: function(data, type, full, meta) {
                        return full.no_npwp;
                    }
                },
                {
                    render: function(data, type, full, meta) {
                        return `<div style="max-width:200px;max-height:150px;overflow:scroll;">${full.work_area}</div>`;
                    }
                },

                {
                    render: function(data, type, full, meta) {
                        return `<div style="max-width:200px;max-height:150px;overflow:scroll;">${full.competencies_name??'-'}</div>`;
                    }
                }, {
                    render: function(data, type, full, meta) {
                        return `<div style="max-width:200px;max-height:150px;overflow:scroll;">${full.sub_competencies_name??'-'}</div>`;
                    }
                },

            ],
            "responsive": false,
            // "initComplete": function(settings, json) {
            //     $('.view_detail').click(function() {
            //         let id = $(this).attr('data-id');
            //         let id_user = $(this).attr('id-user');
            //         viewDetailVendor(id, id_user);
            //     });
            // },
            drawCallback: function(setting) {
                $('.view_detail').click(function() {
                    let id = $(this).attr('data-id');
                    let id_user = $(this).attr('id-user');
                    viewDetailVendor(id, id_user);
                });
            },
            dom: 'Bflrtip',
            buttons: [
                'excel'
            ],
        });

        let fKompetensi = $('#f_kompetensi');
        fKompetensi.change(function() {
            $.ajax({
                url: site_url + '/master/get_data_sub_competency',
                type: 'GET',
                data: {
                    id_competency: $('#f_kompetensi').val() != "" ? $('#f_kompetensi').val() : '-1'
                },
                dataType: 'json',
                success: function(res) {
                    let opt = `<option value="">Semua</option>`;
                    res.forEach(function(i) {
                        opt += `<option value="${i.id}">${i.name}</option>`;
                    });

                    $('#f_sub_kompetensi').html(opt);
                },
                error: function(res, stat, err) {
                    console.log(err);
                }
            });
        });

        let fBranch = $('#f_branch');
        fBranch.change(function() {
            let val = $(this).val();
            $.ajax({
                url: site_url + 'report/get_city_per_branch',
                type: 'get',
                dataType: 'json',
                data: {
                    branch: $('#f_branch').val()
                },
                success: function(res) {
                    let opt = `<option value="">Semua</option>`;
                    res.forEach(function(item) {
                        opt += `<option value="${item.id}">${item.name}</option>`;
                    });
                    $('#f_area_kerja').html(opt);
                },
                error: function(xhr, res, err) {
                    console.log('error');
                }
            });
        });

        $('#btn_filter').click(function() {
            $('#table-report').DataTable().ajax.reload()
        });
    });
</script>